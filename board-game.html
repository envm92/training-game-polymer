<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="./box-game.html">
<link rel="import" href="./score-game.html">

<dom-module id="board-game">
    <template>
        <style>
            :host {
                display: block;
            }
            div {
                display: grid;
                width: 100%;
                height: auto;
                grid: auto-flow / 1fr 1fr 1fr 1fr 1fr;
            }
        </style>
        <paper-input  type="number" min="5" max="10000" value="{{boxCount}}"></paper-input>
        <score-game won="[[won]]" lost="[[lost]]"></score-game>
        <div>
            <template is="dom-repeat" id="boxes-div" items="{{boxes}}">
                <box-game is-winner="{{item.isWinner}}"></box-game>
            </template>
        </div>
    </template>

    <script>
        /**
         * @customElement
         * @polymer
         */
        class BoardGame extends Polymer.Element {

            static get is() { return 'board-game'; }
            static get properties() {
                return {
                    won: {
                        type: Number,
                        value: 0,
                    },
                    lost: {
                        type: Number,
                        value: 0,
                    },
                    boxCount :{
                        type: Number,
                        value: 5,
                        reflectToAttribute: true,
                        observer: '_updateBoxInput'
                    },
                    boxes : {
                        type: Array,
                        value: () => ([])
                    },
                    winner: Number,
                    isWinner: {
                        type:Boolean,
                        default: false
                    },
                    plays: {
                        type: Number,
                        value: 0
                    }
                };
            }

            static get observers() {
                return [
                    '_endGame(plays, isWinner)'
                ]
            }


            connectedCallback() {
                super.connectedCallback();
                this._initGame();
                document.addEventListener('openBox', (e) => {
                    this.set('isWinner', e.detail.isWinner);
                    this.set('plays', this.get('plays') + 1);
                });
            }

            _endGame(plays, isWinner) {
                let isOver = (isWinner|| plays===3);
                if (isOver) {
                    this._showAlert((isWinner) ? 'You win!!' : 'Game over');
                    this._updateScore(isWinner);
                    this._resetGame();
                }
            }

            _initGame() {
                this.winner = Math.floor(Math.random() * Math.floor(this.boxCount));
                this.isWinner = false;
                this.plays = 0;
                this.set('boxes', Array.from({length:this.boxCount},(value, i) => {
                    return {
                        isOpen: false,
                        isWinner: i === this.winner,
                    }
                }));
            }

            _updateBoxInput(newValue, oldValue){
                if (newValue !== undefined) {
                    this._resetGame();
                }
            }

            _showAlert(msg) {
                setTimeout(() => {
                    alert(msg);
                }, 500);
            }

            _resetGame() {
                this.set('boxes', []);
                setTimeout(() => {
                    this._initGame();
                }, 500);

            }

            _updateScore(win) {
                if (win) {
                    this.set('won', this.get('won') + 1);
                } else {
                    this.set('lost', this.get('lost') + 1);
                }
            }
        }

        window.customElements.define(BoardGame.is, BoardGame);
    </script>
</dom-module>